# Designing Your Own Malware Sandbox 
## Rant
When analyzing or executing un-trusted code, it is wise to perform all work in an environment that is isolated from key resources. In particular, I strongly advise you to conduct all research inside of a *sandbox*. A sandbox in the context of computer security is an environment that isolates  some resources from an executing program. 
When analyzing malware, you are strongly encouraged to use an isolated environment. This is to reduce the risk of accidentally infecting your computer or other devices.

An example sandbox that many of you have probably leveraged is found in Window's Antivirus engine. Windows by default will execute every un-trusted executable inside of a sandbox to detect dynamic malicious actions. If the executable was tested in the main environment, this could allow the code to tamper with system resources and defeats the purpose of anti-malware scanning. 

One strategy for creating a sandbox is to use Virtualization based isolation.  This involves using a *Hypervisor* to run a *Virtual Machine*.  A hypervisor is an emulator that allows you to run a *guest OS* inside of your *host OS*.  This class will directly support the use of the Virtualbox Hypervisor, but it is possible to use other including 
- HyperV 
- Vmware (If you have a license great! The vagrant script, however, is not setup to work for Vmware. You would need to make the changes yourself)
- QEMU (not recommended for Windows guest)

This Windows VM will serve as the primary environment where you should run all of your malware. All execution of malicious code should be confined to this environment.  
The Remnux VM is where you will perform most of the dynamic analysis. 


If you have enough space for three VMs,  it is advised to have two separate windows VMs. One for analysis of malware, and one for development of code.

**Disclaimer: Virtualization based isolation is not a fool proof solution**. Exploits for hypervisors exist, and if the malware is packaged with such an exploit they can escape the sandbox. In all likelihood, you are not the target of such a motivated adversary and all malware for this class does not have such a capability. 

  In particular, it is possible that the malware can detect that it is in a virtual environment, and  can escape either via a misconfiguration or exploitation. From there,  it can spread to the host OS.  This is rare in practice but not impossible.  This is  why when analyzing malware from a sophisticated actor, it is essential to do a clean install for each sample, and further more, ensure the host and guest OS are NOT connected to the internet or any critical network via any communication channel (USB, bluetooth, ...etc)

When analyzing crimeware, the setup used in this class should provide adequate guest isolation and should be safe. That said, the course authors make no guarantees about the safety of the sandbox outside of the context of the course.  Failure to configure the sandbox correctly could result in the corruption of host resources.  Please read the following directions very carefully. If you find yourself analyzing sophisticated malware, please consult your  organizations best practices  for best practices. 


# Before you begin:
- Download Virtualbox https://www.virtualbox.org/
- If you want to automate the deployment, download Vagrant https://www.vagrantup.com/downloads
	- Note, don't forget to add vagrant to your path
- Make sure you have git installed on your Host OS
- Clone the course repo


# Remnux 
In this section, you will install and configure Remnux.

- If your host OS is Mac OS or Linux, feel free to download the Virtualbox  OVA file https://docs.remnux.org/install-distro/get-virtual-appliance and follow the directions to import the appliance into Virtualbox. 
- If your Host OS is Windows, you can still import the Remnux OVA  into Virtualbox, but you will have to disable Hyper-V on your host OS. I personally don't like doing this because it prevents you from using WSL and disables virtualization based security/isolation on your host os.
- If you want to keep Hyper-V enabled, please follow the directions here to setup Remnux from scratch. You will need an Ubuntu ISO.
	- https://docs.remnux.org/install-distro/install-from-scratch
	- You are also allowed to use a lighter VM such as a fresh Debian/Ubuntu instance, **but** you will be responsible for installing the required tools. 
	- For this assignment, you will need Inetsim, Wireshark, and iptables. 
- After importing your VM into Virtualbox, click settings, and go to Network. Click on adapter 2 and enable. Then set "Attached to" -> Internal Network  
Fix a name (I chose PrivateNetwork) and click save.
	- For the Vagrant, I chose `ch0nky`
- Once installed, login. (the password is malware)

Our plan is to position Remnux as the default gateway for our windows instance, and force all traffic through it. We can then choose whether or not to relay traffic to the open internet afterwards.
![[network.png]]

To accomplish this, we have two tasks now that our private network is set up. 
- 1) Modify the configuration for your new adapter
- 2) Modify the configuration for a tool called `inetsim`


open up a terminal and run 
```
sudo -i
```
to drop into a root shell . 

Verify that the there is a new network interface (most likely the 3rd one). On my machine, when setup manuallt, it is named `enp0s8`. You can view all network interfaces by running `ip a`
If not, look for the name of the 3rd interface and replace its  `enp0s8` with its name.  If you use Vagrant, it should be `eth1`
![[net_interface.png]]


From there, run the following to create a configuration file that sets your static IP on this interface
```bash
# this creates a new yaml file 
cat >> /etc/netplan/malware-lab.yaml << EOL
network:
        version: 2
        renderer: networkd
        ethernets: 
                enp0s8: 
                        dhcp4: no
                        addresses: 
                                - 10.10.10.2/24
EOL
sudo netplan apply
```

Make sure to replace  `enp0s8` with whatever your new interface is called. On the vagrant box, `enp0s8` will probably be named `eth1`

Finally, run n `accept-all-ips start enp0s8` to allow traffic to the specified interface.  
- *Bonus*: look at how accept-all-ips works. Can you figure out how to perform the same action, except only allow traffic from `10.10.10.3`?

## Configure Inetsim

- Make a copy of the inetsim configuration
- `cp /etc/inetsim/inetsim.conf ~/Desktop/my_inetsim.conf`
	- You can name it whatever you want, and place it anywhere you want. 
	Modify the following:
	
- enable the DNS server by uncommenting `start_service dns`
	- eg![[inetsim_service_dns.png]]
- In service bind address,  set `service_bind_address    10.10.10.2`
	-  eg ![[inetsim_bind_addr.png]]
- In dns_default_ip set `dns_default_ip          10.10.10.2`
- Add `start_service dummy_tcp` in the `# start_service` section
- To modify the port that dummy_tcp runs on, set `dummy_bind_port	1234` in the `# Service Dummy` section
- Finally, run `sudo inetsim --config=~/Desktop/my_inetsim.conf` 

If everything works, you should be able to ping remnux or 10.10.10.2 from your windows box (try this after you set it up)

# Windows Setup
Grab yourself a 90 day trial VM from Microsoft
https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise

You can also use a pre-configured one 
- `https://github.com/gusztavvargadr/packer` 
- https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise
	- Fill in fake information. No need to get spammed by Microsoft
	- From there, add the ISO to a new WIndows VM and follow the directions to get set up. 
	- This should drop you into an Administrator account. From there, you should run the install scripts .

Add the downloaded ISO to the empty disk slot
![[vm_storage_empty.png]]
![[vm_storage_set.png]]

Afterwards, consider adding more CPU resources and video  memory. Finally, click start. 
- On the boot screen, follow the directions to install. You don't need an office account. If it asks for one, click join domain. 
-  Skip the upgrade for now and click custom install 
-  This will take a bit.
-  Just as in Remux, add a new private network interface with the same Network name as chosen previously. 

From there, Copy the install scripts over to your new Windows VM. Run them in the following order: 
- Make sure you have internet `ping 1.1.1.1`
- Install Boxstarter by running from an elevated shell  `box.ps1` 
	- to get an elevated shell, right click powershell.exe and run as admin
- Then from a Boxstarter shell, run the following scripts in order:
	-  `tools.ps1` followed by `network.ps1`
		-  For how to run a powershell script from a command prompt, see https://lmgtfy.app/?q=how+to+run+a+powershell+script+from+command+line :-)
	-  Feel free to customize tools.ps1. I would also advise you to read the contents of the script 
- Optionally, update your windows VM.
- Finally, disable the the NAT interface by clicking the bottom right network icon,  and unchecking the first entry. If you need more tools or need to update, enable the first interface again.  
- ![[Network_addapters.png]]
- The setup script will give you a new, local admin account named Ronald Fillabuster (A great fake name) with a very secure password `P@ssw0rd!`
- Test your connection by trying to ping remnux `ping 10.10.10.2`
- Make sure you can't reach google: `ping 8.8.8.8` and more generally make sure you VM is cut off from the internet. 
- Note that the install scripts bundle together analysis and development tools 
# Setup Flag
- Now that your vms are setup, create a shared folder on your Host OS to your Guest OS. If you want to be extra secure, you can place the shared drive on your Remnux box, and host a simple python server with `python3 -m http.server 1223` to host a static file server on port 1234. To download files, simply visit `http://remnux:1234/` and download files there. 
- If you do directly mount the folder on your guest Windows vm, make sure that it is read only!
- To add a shared folder, select your VM and click settings
- Go to shared folders and add one
- ![[shared_folder.png]]
- Now copy `hw0.exe` over to your windows machine. 
- You should have inetsim running on your Remnux instance configured as described above.
- Open a terminal and run `sudo wireshark`
	- Select the network interface associated with your private network  (`enp0s8/eth1`)
- now On the windows machine, run `hw0.exe`  and wait for execution to terminate. 
- Once the program exits, stop wireshark capture by clicking the shark fin icon in the top left corner.
![[wireshark1.png]]
- Scroll down on the TCP traffic and look for packets that contain the pattern `FLAG{`
![[flag.png]]
- Once found, right click the packet and select `follow-->follow tcp stream`
![[follow_tcp.png]]
- Inside of this window, there should be a flag! submit this to gradescope.
![[flag2.png]]
- You probably shouldn't waist  your time trying to  reverse the binary since it is protected with military grade obfuscation. 




# Vagrant Setup
- If you opt to use Vagrant to setup your environment, open a terminal in the  Remnux directory. 
Run `vagrant up  --provision`

- Once it finishes, you should have a remnux VM. You should expect installation to take 1-2 hours. 
- To monitor progress, open up Virtualbox and select `show` on the new VM
- Once installed, you can run `vagrant up` 

# Windows
- Run `vagrant up`
- This will take a bit to download and setup the windows VM. You will probably see an error on the virtualbox GUI. Click ignore, and restart once it finishes. 
- Try running `vagrant up` followed by `vagrant ssh`
- If everything works, run `vagrant up --provision`
- Warnining: I read through the packer script used to create the 3rd party windows Vagrant box, but I make no guarantees that it isn't backdoored in some way.   Use at your own peril :-)

